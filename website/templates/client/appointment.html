{% extends "client/base.html" %}

{% block style %}
    <style>
        .selected {
            border: solid;
            color: green;
        }
    </style>

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

{% endblock %}

{% block content %}

    <section data-bs-version="5.1" class="features6 cid-sXTmOgU3Ke" id="afeatures6-2">


        <div class="container">
            <div class="row justify-content-center">

                <div class="col-12 col-lg-12 col-md-7 col-text">
                    <div class="text-wrapper">
                        <h1 class="mbr-section-title mbr-fonts-style display-5 mb-5"><strong>Prenotazione di un
                            appuntamento</strong></h1>

                        <!-- SmartWizard html -->
                        <div id="smartwizard" dir="" class="sw sw-theme-arrows">
                            <ul class="nav nav-progress">
                                <li class="nav-item">
                                    <a class="nav-link default active" href="#step-1">
                                        <div class="num">1</div>
                                        Accesso
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link default" href="#step-2">
                                        <span class="num">2</span>
                                        Scelta del servizio
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link default" href="#step-3">
                                        <span class="num">3</span>
                                        Scelta dell'orario
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link default" href="#step-4">
                                        <span class="num">4</span>
                                        Conferma
                                    </a>
                                </li>
                            </ul>

                            <div class="tab-content" style="height: 187.188px;">

                                <div id="step-1" class="tab-pane" role="tabpanel" aria-labelledby="step-1"
                                     style="position: static; left: 0px; display: block;">
                                    <div class="container">
                                        <form>
                                            <div class="form-group">
                                                <label for="email">Indirizzo e-mail</label>
                                                <input type="email" class="form-control" id="email" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="password">Password</label>
                                                <input type="password" class="form-control" id="password" required>
                                            </div>

                                            <a class="btn btn-primary" id="login" href="javascript:void(0)">
                                                Accedi
                                            </a>
                                        </form>
                                        <div id="success-alert" class="alert alert-success" role="alert"
                                             style="display: none;">
                                            Accesso riuscito
                                        </div>
                                    </div>
                                </div>

                                <div id="step-2" class="tab-pane" role="tabpanel" aria-labelledby="step-2"
                                     style="position: static; left: 0px; display: none;">
                                    <div class="table-responsive">
                                        <table class="table align-items-center mb-0">
                                            <thead>
                                            <tr>
                                                <th></th>
                                                <th></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for service in services %}
                                                <tr id="{{ service.id }}" class="clickable">
                                                    <td>
                                                        <div class="d-flex px-2 py-1">
                                                            <div>
                                                                <img src="https://png.pngtree.com/png-clipart/20200225/original/pngtree-customer-service-icon-png-image_5257338.jpg"
                                                                     class="avatar avatar-sm me-3"
                                                                     alt="avatar image" style=" width: 50px;">
                                                            </div>
                                                            <div class="d-flex flex-column justify-content-center">
                                                                <h6 class="mb-2 font-weight-normal text-sm">{{ service.name }}</h6>
                                                                <p class="text-sm font-weight-normal mb-0">{{ service.duration }}
                                                                    minuti</p>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="mbr-iconfont mbri-cursor-click mobi-mbri"></span>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div id="step-3" class="tab-pane" role="tabpanel" aria-labelledby="step-3"
                                     style="position: static; left: 0px; display: none;">
                                    <div class="row" style="margin-top:20px">
                                        <div class="col-xs-12 col-md-3">
                                            <div id="datepicker"></div>
                                        </div>


                                        <div class="col-xs-12 col-md-9">
                                            <div class="col-md-12" style="margin-bottom:20px">Orari disponibili:

                                                <div class="row" id="resAvailable" style="margin-top:20px">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="step-4" class="tab-pane" role="tabpanel" aria-labelledby="step-4"
                                     style="position: static; left: 0px; display: none;">
                                    <div class="container">
                                        <div class="row mt-2">
                                            <div class="col">

                                            </div>
                                            <div class="col-6">
                                                <h5>Cliente: <span id="customerName"></span></h5>
                                                <h5>Servizio: <span id="customerService"></span></h5>
                                                <h5>Data: <span id="customerData"></span></h5>
                                                <h5>Orario: <span id="customerHour"></span></h5>

                                                <div class="form-floating">
                                                    <textarea class="form-control" placeholder="Recapito" id="recapito"
                                                              style="height: 100px" required></textarea>
                                                    <label for="recapito">Recapito</label>
                                                </div>

                                                <p class="mt-3 mb-3">Comunicazioni da inviare all'azienda</p>
                                                <div class="mb-3">
                                                    <textarea class="form-control" id="notes"
                                                              rows="3"></textarea>
                                                </div>
                                                <a class="btn btn-primary mt-3" id="confirm" href="javascript:void(0)">
                                                    Conferma
                                                </a>
                                            </div>
                                            <div class="col">

                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block scripts %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.it.min.js"></script>

    <script>
        const loc = window.location.hash
        if (loc === "#step-2" || loc === "#step-3" || loc === "#step-4") {
            window.location.hash = "#step-1";
        }

        $('#datepicker').datepicker({
            format: 'dd/mm/yyyy',
            startDate: '-2d',
            updateViewDate: false,
            autoclose: true,
            title: "Seleziona una data",
            language: "it",
            daysOfWeekDisabled: "0,6",
            todayHighlight: true,
        });

        $('#datepicker').datepicker().on('changeDate', function (e) {

            document.querySelector("#smartwizard > div.sw-toolbar-elm.toolbar.toolbar-bottom > button.btn.sw-btn-next.sw-btn").id = 'next'
            document.getElementById('next').classList.add('disabled');

            const selectedDate = e.date;

            selectedDate.setDate(selectedDate.getDate());
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            var today = new Date();
            var tenDaysFromNow = new Date(today);
            tenDaysFromNow.setDate(today.getDate() + 10);

            if (selectedDate > today && selectedDate <= tenDaysFromNow) {
                $.ajax({
                    url: '/datepicker',
                    type: 'POST',
                    data: {selectedDate: formattedDate},
                    success: function (response) {
                        if (response) {
                            createReservationButtons(response);
                        }
                    },
                    error: function (error) {
                        console.error('error:', error);
                    }
                });
            } else {
                createReservationButtons(0);
            }

        });

        function createReservationButtons(availableHours) {
            var reservationContainer = document.getElementById('resAvailable');
            reservationContainer.innerHTML = '';
            if (availableHours == 0) {
                var reservationItem = document.createElement('div');
                reservationItem.className = 'col-xs-6 col-md-3';

                var reservationButton = document.createElement('div');
                reservationButton.className = 'reservation-item';

                var reservationText = document.createElement('div');
                reservationText.className = 'reservation-item-hours';
                reservationText.textContent = 'Non disponibile'
                reservationButton.appendChild(reservationText);
                reservationItem.appendChild(reservationButton);
                reservationContainer.appendChild(reservationItem);
            } else {
                availableHours.forEach(function (hour) {
                    var reservationItem = document.createElement('div');
                    reservationItem.className = 'col-xs-6 col-md-3';

                    var reservationButton = document.createElement('div');
                    reservationButton.className = 'reservation-item';
                    reservationButton.setAttribute('data-reservation-hours-ind', hour);

                    var reservationText = document.createElement('div');
                    reservationText.className = 'reservation-item-hours';
                    reservationText.textContent = hour + ':00 - ' + (hour + 1) + ':00';

                    reservationButton.appendChild(reservationText);
                    reservationItem.appendChild(reservationButton);
                    reservationContainer.appendChild(reservationItem);

                    // Adaugă un eveniment click pentru fiecare pulsant pentru a manipula rezervarea
                    reservationButton.addEventListener('click', function () {
                        // Aici poți adăuga cod pentru manipularea rezervării atunci când un pulsant este apăsat
                        console.log('Button clicked for hour: ' + hour);
                    });
                });
            }
        }


        $('#smartwizard').smartWizard({});

        $(document).ready(function () {


            function disable() {
                document.querySelector("#smartwizard > div.sw-toolbar-elm.toolbar.toolbar-bottom > button.btn.sw-btn-next.sw-btn").id = 'next'
                document.getElementById('next').classList.add('disabled');
            }

            function enable() {
                document.getElementById('next').classList.remove('disabled');
            }

            disable();

            step1();
            step2();

            function checkURL() {
                var currentURL = window.location.href;
                if (currentURL.includes('#step-1')) {
                    {#step1();#}
                } else if (currentURL.includes('#step-2')) {
                    step2check();
                } else if (currentURL.includes('#step-3')) {
                    step3();
                } else if (currentURL.includes('#step-4')) {
                    step4();
                }
            }

            setInterval(checkURL, 1000);

            function step1() {
                var loginBtn = document.getElementById('login');
                loginBtn.addEventListener('click', function () {
                    var emailInput = document.getElementById("email");
                    var passwordInput = document.getElementById("password");

                    var email = emailInput.value;
                    var password = passwordInput.value;

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/client-login", true);
                    xhr.setRequestHeader("Content-Type", "application/json");

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            // Răspunsul de la server (dacă este necesar)
                            var response = xhr.responseText;
                            const data = JSON.parse(response);
                            const customer = data.customer;

                            console.log(customer);
                            localStorage.setItem('customer', JSON.stringify(customer));

                            showSuccessAlert();

                            {#$('#smartwizard').smartWizard("next");#}
                            setTimeout(() => {
                                enable();
                            }, 1000);

                        }
                    };

                    var data = {
                        email: email,
                        password: password
                    };

                    var jsonData = JSON.stringify(data);

                    xhr.send(jsonData);
                });

                function showSuccessAlert() {
                    var successAlert = document.getElementById('success-alert');
                    successAlert.style.display = 'block';

                    document.querySelector("#step-1 > div > form").hidden = true
                }
            }

            function step2check() {
                var clickableElements = document.querySelectorAll('.clickable');
                const hasSelected = Array.from(clickableElements).some(element => element.classList.contains('selected'));
                hasSelected ? '' : disable();
            }

            function step2() {
                step2check();
                var clickableElements = document.querySelectorAll('.clickable');
                clickableElements.forEach(function (element) {
                    element.addEventListener('click', function () {
                        if (!element.classList.contains('selected')) {
                            clickableElements.forEach(function (otherElement) {
                                otherElement.classList.remove('selected');
                            });
                            element.classList.add('selected');
                            document.getElementById('next').classList.remove('disabled')
                        } else {
                            element.classList.remove('selected');
                            document.getElementById('next').classList.add('disabled')
                        }
                    });
                });
            }

            function step3check() {
                var selectedItems = document.querySelectorAll('.reservation-item.reservation-item-selected');

                if (selectedItems.length === 0) {
                    disable();
                } else {
                    enable();
                }
            }

            function step3() {
                step3check();
                const reservationItems = document.querySelectorAll('.reservation-item');

                reservationItems.forEach(item => {
                    item.addEventListener('click', () => {
                        reservationItems.forEach(otherItem => {
                            otherItem.classList.remove('reservation-item-selected');
                        });
                        item.classList.add('reservation-item-selected');
                        step3check()
                    });
                });
            }

            function step4() {
                const customerString = localStorage.getItem('customer');
                const customer = JSON.parse(customerString);
                const customerNameElement = document.getElementById('customerName');
                if (customer && customer.name && customer.surname) {
                    customerNameElement.textContent = `${customer.name} ${customer.surname}`;
                } else {
                    customerNameElement.textContent = 'error';
                }

                const customerService = document.querySelector('tr.clickable.selected').innerText
                const customerServiceElement = document.getElementById('customerService');
                if (customerService) {
                    customerServiceElement.textContent = `${customerService} `;
                } else {
                    customerServiceElement.textContent = 'error';
                }


                const selectedDate = $('#datepicker').datepicker('getDate');
                const customerData = selectedDate.toLocaleDateString('it-IT');
                const customerDataElement = document.getElementById('customerData');
                if (customerData) {
                    customerDataElement.textContent = `${customerData} `;
                } else {
                    customerDataElement.textContent = 'error';
                }


                const customerHour = document.querySelector('.reservation-item.reservation-item-selected').innerText
                const customerHourElement = document.getElementById('customerHour');
                if (customerHour) {
                    customerHourElement.textContent = `${customerHour} `;
                } else {
                    customerHourElement.textContent = 'error';
                }


            }

            function conferma() {
                var confirmBtn = document.getElementById('confirm');
                confirmBtn.addEventListener('click', function () {

                    const recapito = document.getElementById('recapito').value;

                    if (recapito.length < 1) {
                        alert('Si prega di inserire il recapito')
                    } else {

                        const customerString = localStorage.getItem('customer');
                        const customer = JSON.parse(customerString);

                        const selectedDate = $('#datepicker').datepicker('getDate');
                        const customerData = selectedDate.toLocaleDateString('it-IT');

                        const emailCliente = customer.email;
                        const servizioCliente = document.querySelector('tr.clickable.selected').id;
                        const dataCliente = customerData;
                        const orarioCliente = document.querySelector('.reservation-item.reservation-item-selected').dataset.reservationHoursInd;
                        const noteCliente = document.getElementById('notes').value;

                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "/crea-appuntamento", true);
                        xhr.setRequestHeader("Content-Type", "application/json");

                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4) {
                                if (xhr.status === 200 || xhr.status === 201) {
                                    var response = xhr.responseText;
                                    const data = JSON.parse(response);
                                    if (data.message === "Appointment added successfully") {
                                        var smartWizardElement = document.getElementById('smartwizard');

                                        var successAlert = document.createElement('div');
                                        successAlert.className = 'alert alert-success';
                                        successAlert.textContent = 'La sua richiesta per l\'appuntamento è stata correttamente inviata.';

                                        smartWizardElement.parentNode.replaceChild(successAlert, smartWizardElement);

                                    } else {
                                        alert('I dati non sono validi')
                                    }
                                } else {
                                    alert('Erorre durante la Conferma')
                                }
                            }
                        };


                        var data = {
                            emailCliente: emailCliente,
                            servizioCliente: servizioCliente,
                            dataCliente: dataCliente,
                            orarioCliente: orarioCliente,
                            noteCliente: noteCliente,
                            recapitoCliente : recapito
                        };

                        var jsonData = JSON.stringify(data);

                        xhr.send(jsonData);
                    }
                });
            }

            conferma();


        });


    </script>


{% endblock %}
